<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Audio Converter</title>

<style>
    body {
        font-family: system-ui, sans-serif;
        background: #f1f3f7;
        margin: 0; padding: 0;
        display: flex; justify-content: center; align-items: center;
        height: 100vh;
    }
    .card {
        background: white;
        padding: 2rem;
        border-radius: 12px;
        width: 420px;
        box-shadow: 0 6px 20px rgba(0,0,0,0.1);
    }
    h1 {
        margin-top: 0;
        font-size: 1.4rem;
        text-align: center;
    }
    label { font-weight: 600; display: block; margin-top: 1rem; }
    input[type="number"] { width: 100%; padding: 0.4rem; margin-top: 0.3rem; }
    .row { display: flex; gap: 1rem; }
    button {
        margin-top: 1.5rem;
        width: 100%;
        padding: 0.7rem;
        background: #0077ff;
        color: white;
        border: none;
        border-radius: 6px;
        font-size: 1rem;
        cursor: pointer;
        transition: 0.2s;
    }
    button:hover { background: #005fd4; }

    #status { margin-top: 1rem; font-weight: bold; }
    #error-log {
        margin-top: 1rem;
        color: red; font-family: monospace;
        white-space: pre-wrap;
        display:none;
    }
</style>
</head>
<body>

<div class="card">
    <h1>Audio Converter</h1>

    <label>Select an Audio File</label>
    <input type="file" id="fileInput" accept="audio/*">

    <label>Convert To Format</label>
    <select id="formatSelect">
        <option value="mp3">MP3</option>
        <option value="wav">WAV</option>
    </select>

    <div class="row">
        <div style="flex:1">
            <label>Trim Start (sec)</label>
            <input type="number" id="trimStart" min="0" placeholder="0">
        </div>
        <div style="flex:1">
            <label>Trim End (sec)</label>
            <input type="number" id="trimEnd" min="0" placeholder="0">
        </div>
    </div>

    <label>
        <input type="checkbox" id="autoTrim"> Auto-trim silence
    </label>

    <button id="convertBtn">Convert</button>

    <div id="status">Initializing FFmpeg…</div>
    <pre id="error-log"></pre>
</div>

<!-- Self-hosted wrapper -->
<script src="./ffmpeg.min.js"></script>

<script>
const statusEl = document.getElementById("status");
const errorLogEl = document.getElementById("error-log");

const { createFFmpeg, fetchFile } = FFmpeg;

// Build absolute URL to ffmpeg-core.js so GitHub Pages loads it correctly
const corePath = new URL("./ffmpeg-core.js", window.location.href).href;

const ffmpeg = createFFmpeg({
    log: true,
    mainName: "main",
    corePath
});

// Initialize FFmpeg
(async () => {
    try {
        statusEl.textContent = "Loading FFmpeg core…";
        await ffmpeg.load();
        statusEl.textContent = "FFmpeg ready.";
    } catch (err) {
        statusEl.textContent = "Failed to load FFmpeg.";
        errorLogEl.textContent = err;
        errorLogEl.style.display = "block";
    }
})();

// Handle Conversion
document.getElementById("convertBtn").onclick = async () => {
    const fileInput = document.getElementById("fileInput");
    const format = document.getElementById("formatSelect").value;
    const trimStart = Number(document.getElementById("trimStart").value || 0);
    const trimEnd = Number(document.getElementById("trimEnd").value || 0);
    const autoTrim = document.getElementById("autoTrim").checked;

    if (!fileInput.files.length) {
        alert("Please select a file.");
        return;
    }

    const file = fileInput.files[0];
    const inputName = "input." + file.name.split(".").pop();
    const outputName = "output." + format;

    statusEl.textContent = "Processing…";

    try {
        // Write uploaded file into FFmpeg FS
        ffmpeg.FS("writeFile", inputName, await fetchFile(file));

        const args = ["-i", inputName];

        // TRIM START
        if (trimStart > 0) args.push("-ss", `${trimStart}`);

        // TRIM END
        if (trimEnd > 0) {
            // Need file duration → run ffprobe equivalent
            statusEl.textContent = "Calculating duration…";
            const probe = await ffmpeg.run(
                "-i", inputName,
                "-hide_banner"
            );
            // FFmpeg always prints metadata to stderr
            const info = ffmpeg.stderr.join("\n");
            const match = info.match(/Duration:\s(\d+):(\d+):(\d+\.\d+)/);

            if (match) {
                const dur =
                    Number(match[1]) * 3600 +
                    Number(match[2]) * 60 +
                    Number(match[3]);

                const newDur = Math.max(0, dur - trimEnd);
                args.push("-t", `${newDur}`);
            }
        }

        // AUTO TRIM SILENCE
        if (autoTrim) {
            args.push(
                "-af",
                "silenceremove=start_periods=1:start_duration=0.1:start_threshold=-50dB:\
end_periods=1:end_duration=0.1:end_threshold=-50dB"
            );
        }

        // Output file
        args.push(outputName);

        console.log("FFmpeg args:", args);

        statusEl.textContent = "Running FFmpeg…";

        await ffmpeg.run(...args);

        statusEl.textContent = "Conversion complete. Preparing download…";

        // Read file back
        const data = ffmpeg.FS("readFile", outputName);

        // Download
        const blob = new Blob([data.buffer], { type: format === "mp3" ? "audio/mpeg" : "audio/wav" });
        const url = URL.createObjectURL(blob);

        const a = document.createElement("a");
        a.href = url;
        a.download = outputName;
        a.click();

        URL.revokeObjectURL(url);

        statusEl.textContent = "Done!";
    } catch (err) {
        statusEl.textContent = "Error during conversion.";
        errorLogEl.textContent = err;
        errorLogEl.style.display = "block";
    }
};
</script>

</body>
</html>
